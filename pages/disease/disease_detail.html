<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>病虫害修改</title>
<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="../../layui/css/layui.css" media="all" />
</head>

<body>

<div id="addForm">
		<form id="saveForm" class="form-horizontal">
			<div class="row">
					<div class="col-sm-4">
						<div class="form-group">
					    <label for="" class="col-sm-4 control-label">名称:</label>
					    <div class="col-sm-8">
					     <input type="text" name="name" class="form-control" id="name">
					    </div>
				    </div>
				  </div>


	               <div class="col-sm-4">
						<div class="form-group">
					    <label for="" class="col-sm-4 control-label">标签:</label>
					    <div class="col-sm-8">
					     <input type="text" name="tag" class="form-control" id="tag">
					    </div>
				    </div>
				  </div>


				  <div class="col-sm-4">
				  	<div class="form-group">
					    <label for="description" class="col-sm-4 control-label">有效期:</label>
					    <div class="col-sm-8">
					      <input type="number" name="forecastLength" class="form-control" id="forecastLength">
					    </div>
				    </div>
				 </div>
			</div>
			<div class="row">
				<div class="col-sm-4">
					<div class="form-group">
					    <label for="" class="col-sm-4 control-label">等级:</label>
					    <div class="col-sm-8">
					    	<select class="form-control" name="level" id="level">
					    		<option value="0">默认</option>
					    		<option value="5">轻度</option>
					    		<option value="10">中度</option>
					    		<option value="15">严重</option>
					    	</select>
					    </div>
					</div>
				</div>
				<div class="col-sm-4">
					<div class="form-group">
					    <label for="" class="col-sm-4 control-label">图标:</label>
					    <div class="col-sm-8">
					      <select class="form-control" name="warnIcon" id="warnIcon">
					    		<option value="100">病害</option>
					    		<option value="101">虫害</option>
					    		<option value="102">干热风</option>
					    		<option value="103">寒露风</option>
					    		<option value="1040">霜冻-轻度</option>
					    		<option value="1041">霜冻-中度</option>
					    		<option value="1042">霜冻-重度</option>
					    		<option value="105">寒潮-默认</option>
					    		<option value="1050">寒潮-轻度</option>
					    		<option value="1051">寒潮-中度</option>
					    		<option value="1052">寒潮-重度</option>
					    	</select>
					    </div>
					</div>
				</div>
			</div>

	       <div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">图片:</label>
				    <div class="col-sm-8">
				     <textarea class="layui-textarea" id="demo" >  
					 </textarea>
				    </div>
				  </div>
				</div>
		  	</div>
		  	<div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">病原菌或虫源:</label>
				    <div class="col-sm-8">
				      <textarea class="form-control" rows="2" name="cause" id="cause"></textarea>
				    </div>
				  </div>
				</div>
		  	</div>
		  	<div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">危害症状:</label>
				    <div class="col-sm-8">
				      <textarea class="form-control" name="symptoms" id="symptoms" rows="2"></textarea>
				    </div>
				  </div>
				 </div>
		  	</div>
		  	<div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">环境条件描述::</label>
				    <div class="col-sm-8">
				      <textarea class="form-control" name="environmentalConditions" id="environmentalConditions" rows="2"></textarea>
				    </div>
				  </div>
			    </div>
		  	</div>
		  	<div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">解析:</label>
				    <div class="col-sm-8">
				      <textarea class="form-control" rows="2"  name="analytic" id="analytic"></textarea>
				    </div>
				  </div>
			    </div>
		  	</div>
             <div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">防治方法:</label>
				    <div class="col-sm-8">
				      <textarea class="form-control" rows="2"  name="controlMethods" id="controlMethods"></textarea>
				    </div>
				  </div>
			    </div>
		  	</div>

		  	<div class="row">
		  		<div class="col-sm-8">
				  <div class="form-group">
				    <label for="description" class="col-sm-2 control-label">正常描述:</label>
				    <div class="col-sm-8">
				      <textarea class="form-control" rows="2"  name="nomalDesc" id="nomalDesc"></textarea>
				    </div>
				  </div>
			    </div>
                <div class="col-sm-6">
					<div class="form-group">
					    <label for="" class="col-sm-4 control-label">类型:</label>
					    <div class="col-sm-8">
					      	<select class="form-control" name="diseaseType" id="diseaseType">
								<option value="病害">病害</option>
								<option value="虫害">虫害</option>
								<option value="气象灾害">气象灾害</option>
							</select>
					    </div>
					</div>
				</div>


		  	</div>
		  	<div class="row">
				<div class="col-sm-6">
					<div class="form-group">
					    <label for="" class="col-sm-4 control-label">匹配显示位置:</label>
					    <div class="col-sm-8">
					      	 <select class="form-control" name="matchingPosition" id="matchingPosition">
					    		<option value="1">农事建议页面</option>
					    		<option value="2">其他项页</option>
					    		<option value="0">不显示</option>
					    	</select>
					    </div>
					</div>
				</div>
				<div class="col-sm-6">
					<div class="form-group">
					    <label for="" class="col-sm-4 control-label">不匹配显示位置:</label>
					    <div class="col-sm-8">
					      	<select class="form-control" name="noMatchingPosition" id="noMatchingPosition">
					    		<option value="1">农事建议页面</option>
					    		<option value="2">其他项页</option>
					    		<option value="0">不显示</option>
					    	</select>
					    </div>
					</div>
				</div>
			</div>
		  	
		  	<div class="index-set">
		  		<div class="row title">
		  			<div class="col-sm-12">
		  				<h3 class="pull-left">影响因素设置</h3>
		  				<a id="add" onclick="blankRowInfo();" class="btn btn-primary pull-right" href="javascript:;"><i class="fa fa-plus"></i>添加</a>
		  			</div>
		  		</div>
		  		<div id="quotaRows">
			  		
		  		</div>
		  	</div>
		</form>

		 <div class="form-actions">
				<div class="row" align="center">
					<div class="col-md-12">
						<button class="btn btn-primary" type="submit" onclick="updateSQ(this, true)">
							<i class="fa fa-save"></i> 保存
						</button>
					</div>
				</div>
			</div>
	</div>

</body>
<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script type="text/javascript">

 var layer;
var layedit, index;
//添加条目
     var addIndex = 1;
       //初始化加载
    var id = getUrlParam("id");//农气指导id
  var ss=layui.use(['layer','util', 'laydate','layedit','upload'], function(){
       layer= layui.layer;
      layedit = layui.layedit;
		  layedit.set({
              uploadImage: {
                  url: domainName+"/api-f/files/layui?fileSource=QINIUYUN",
                  type: 'post'
              }
            });
			
		  index =  layedit.build('demo', {
                tool: ['image'],//设置需要的控件
                height: 280 //设置高度
            });  
	});


         var elementSize = 1;//指标个数，删除时使用
         var elementIdOptions = '';
		 $(function(){
		    $.ajax({
                     type: "GET", //获得所有影响要素
                     url: domainName+'/api-ag/quota/listElement', 
                     async : false,
                     dataType: "json", //json格式，后台返回的数据为json格式的。
                     success: function(response){
		               $.each(response.data,function(i,obj){
			           elementIdOptions += '<option value="'+obj.id+'">'+obj.name+'</option>';
		                 });
		              $('[name="elementId"]').html(elementIdOptions);
		                 initData();

                    }    
                })


				
          });














      //初始化回显数据
        function initData(){
 
            if(id!=""){
                $.ajax({
                type : 'get',
                url : domainName + '/api-ag/disease/selectById?id='+id,
                async : false,
                success : function(data) {
              if(data.code==200){
              $("#name").val(data.data.name);
              $("#forecastLength").val(data.data.forecastLength);
              $("#level").find("option[value = '"+data.data.level+"']").attr("selected","selected");
              $("#warnIcon").find("option[value = '"+data.data.warnIcon+"']").attr("selected","selected");
              if(data.data.icon!=""||data.data.icon!=null){
                    $("#demo").text("<image src="+data.data.icon+"/>");
              }
              $("#cause").val(data.data.cause);
              $("#tag").val(data.data.tag);
              $("#symptoms").val(data.data.symptoms);
              $("#environmentalConditions").val(data.data.environmentalConditions);
              $("#analytic").val(data.data.analytic);
              $("#controlMethods").val(data.data.controlMethods);
              $("#nomalDesc").val(data.data.nomalDesc);
              $("#diseaseType").find("option[value = '"+data.data.diseaseType+"']").attr("selected","selected");
              $("#matchingPosition").find("option[value = '"+data.data.matchingPosition+"']").attr("selected","selected");
              $("#noMatchingPosition").find("option[value = '"+data.data.noMatchingPosition+"']").attr("selected","selected");

                      var tquotas=data.data.tquotas;
                       $("#quotaRows").empty();//一定要记得清楚dom
                    for(var n=0;n<tquotas.length;n++){//循环出表格
                            blankRowInfo ();//拼接表格
                           //然后开始选中，填充数据
                           var index=n+1;
                          $("#elementId"+index+"").find("option[value = '"+tquotas[n].elementId+"']").attr("selected","selected");
                          $("#minVal"+index+"").val(tquotas[n].minVal);
                          $("#maxVal"+index+"").val(tquotas[n].maxVal);
                          $("#sysytem"+index+"").val(tquotas[n].id);
                    }


                  }
            

                    }
                });
            }

      }
























    
	function blankRowInfo (rowId,index) {
		
	var str ='<div class="row" id="rowIds'+addIndex+'" name="rowIds"><div class="col-sm-4"><div class="form-group"><label name="yxQuota" for="" class="col-sm-4 control-label">影响要素:</label><div class="col-sm-8">';
        str +='<select id="elementId'+addIndex+'" class="form-control" name="elementId" attr="elementId">';
        str += elementIdOptions;
        str += '</select></div></div></div><div class="col-sm-3"><div class="form-group"><label for="" class="col-sm-4 control-label">最低值:</label>';
        str += '<div class="col-sm-8"><input type="number" class="form-control" attr="minVal" name="minVal" id="minVal'+addIndex+'"><input type="hidden" id="sysytem'+addIndex+'" name="quotaIds"/>';
        str += '</div></div></div>';
        str += '<div class="col-sm-3"><div class="form-group"><label for="" class="col-sm-4 control-label">最高值:</label><div class="col-sm-8">';
        str += '<input type="number" class="form-control" id="maxVal'+addIndex+'" name="maxVal" attr="maxVal"></div></div></div>';
        str += '<input type="button" class="del-index" value="删除" onclick="deleteRow(\'rowIds'+addIndex+'\');"/></div>';
        addIndex++;
        $("#quotaRows").append(str);
	}


  //删除条目
	function deleteRow(rowId) {
		layer.confirm('确定要移除本条记录？', function(index){
			$("#"+rowId).remove();
	        layer.close(index);
	     });
		
	}



//修改病虫害指标
function  updateSQ(obj){

              var selectInfluenceName=$("select[name='elementId'] option:selected");
              var selectInfluenceMixValue=$("input[name='minVal']");
              var selectInfluenceMaxValue=$("input[name='maxVal']");
               var systemluenceIds=$("input[name='quotaIds']");//指标id
		      var influenceArray=new Array();//所有的影响指标id
		      var influenceMixArray=new Array()//影响的最小值
		      var influenceMaxArray=new Array()//影响的最大值
		      var systemluenceIdsArray=new Array()//系统回显的指标id
              var imgUrl;
		   for (i=0;i<selectInfluenceName.length;i++){//拿到所有的病虫害
		       influenceArray.push($(selectInfluenceName[i]).val());
		       if($(selectInfluenceMixValue[i]).val()==""||$(selectInfluenceMaxValue[i]).val()==""){
                layer.alert("参数值不允许为空", {
			          icon: 5,
			          title: "提示"
		             });
					 return false;
		       }
		       influenceMixArray.push($(selectInfluenceMixValue[i]).val());
		       influenceMaxArray.push($(selectInfluenceMaxValue[i]).val());
		       systemluenceIdsArray.push($(systemluenceIds[i]).val());
		    }
		     var re=/src="[^"]+/g;
			 var backeurl=layedit.getContent(index);
			 var arr=backeurl.match(re),re_arr=[];
			 if(backeurl.indexOf("http") != -1){
			 	for(var i=0,len=arr.length;i<len;i++){
               re_arr.push(arr[i].substr(5));
             };
		       imgUrl =re_arr[0];
			  if(imgUrl .indexOf("?") != -1){
               imgUrl  =imgUrl .split("?")[0];
               }
			 }
			 
         
      
           $.ajax({
				type : 'post',
				url : domainName+"/api-ag/disease/updateDisease",
				dataType: "json",
               traditional: true,
				data :{
				id: id, 
				tag:$('#tag').val(),
			    quotaId:systemluenceIdsArray,
				name:$("#name").val(),
				forecastLength:$("#forecastLength").val(),
				level:$("#level option:selected").val(),
				warnIcon:$("#warnIcon option:selected").val(),
                icon: imgUrl,
                cause:$("#cause").val(),
                symptoms: $("#symptoms").val(),
                environmentalConditions: $("#environmentalConditions").val(),
                analytic: $("#analytic").val(),
                nomalDesc:$("#nomalDesc").val(),
				controlMethods:$("#controlMethods").val(),
				diseaseType:$("#diseaseType option:selected").val(),
				matchingPosition:$("#matchingPosition option:selected").val(),
				noMatchingPosition:$("#noMatchingPosition option:selected").val(),
				elementId:influenceArray,
				minVal:influenceMixArray,
				maxVal:influenceMaxArray
				},
				success : function(data) {
				   if(data.code==200){//成功
				  layer.alert("保存成功", {
			          icon: 6,
			          title: "提示"
		             });
	            //关闭页面
             var index=parent.layer.getFrameIndex(window.name);//获取当前弹出层的层级
             window.parent.location.reload();//刷新父页面
             parent.layer.close(index);//关闭弹出层 
				   }else{//失败
				   layer.alert("保存失败", {
			          icon: 5,
			          title: "提示"
		             });
					 return false;
				   }
				}
            });

};



</script>